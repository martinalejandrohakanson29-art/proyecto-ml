<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ventas ML</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --border:#1f2937; --row:#0b1220; --row-alt:#0e1727; --row-hover:#0f1c31;
    }
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg),#090f1d 40%,#070b16);
      color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{
      background:linear-gradient(180deg,rgba(30,58,138,.25),rgba(17,24,39,.6));
      border:1px solid var(--border);border-radius:16px;overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .card-header{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      padding:16px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,rgba(2,6,23,.9),rgba(2,6,23,.5));
    }
    .title{font-weight:700;color:#fff;margin-right:auto}
    label{font-size:12px;color:var(--muted)}
    input[type="date"]{
      background:#0b1220;color:#fff;border:1px solid var(--border);
      border-radius:10px;padding:8px 10px;outline:none
    }
    .btn{
      background:linear-gradient(90deg,#22c55e,#06b6d4);
      color:#001018;font-weight:700;border:0;border-radius:12px;
      padding:10px 14px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.3);
    }
    .btn.secondary{background:transparent;color:#9bd2ff;border:1px solid #2460b3}
    .meta{font-size:12px;color:#bcd7ff}

    .table-wrap{overflow:auto;max-height:70vh;border-top:1px solid var(--border)}
    table{
      width:100%;border-collapse:separate;border-spacing:0;
      table-layout:fixed; /* NECESARIO para que el resize funcione */
    }
    thead th{
      position:sticky;top:0; /* pegado al tope del contenedor que scrollea */
      background:linear-gradient(180deg,rgba(18,28,48,.95),rgba(9,14,26,.95));
      border-bottom:1px solid var(--border);
      padding:10px 12px;font-size:12px;font-weight:700;color:#9bd2ff;
      text-align:left;white-space:nowrap;vertical-align:bottom;
      z-index:2;
    }
    tbody td{
      border-bottom:1px dashed #0e213f;padding:10px 12px;font-size:13px;color:#e6f0ff;
      white-space:nowrap;vertical-align:top;overflow:hidden;text-overflow:ellipsis;
    }
    tbody tr:nth-child(odd){background:linear-gradient(180deg,#0b1220,#0c1425)}
    tbody tr:nth-child(even){background:linear-gradient(180deg,#0c1425,#0d1628)}
    tbody tr:hover{background:linear-gradient(180deg,#0f1c31,#132542)}

    .th-wrap{position:relative;display:flex;align-items:center;gap:8px}
    .col-resizer{
      position:absolute;top:0;right:0;height:100%;width:8px;cursor:col-resize;
      user-select:none;background:linear-gradient(180deg,transparent,transparent);
    }
    .col-resizer:hover{background:linear-gradient(180deg,transparent,rgba(96,165,250,.08),transparent)}
    body.resizing{cursor:col-resize;user-select:none}
    .num{text-align:right}
    .idcell{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-header">
        <div class="title">Ventas Mercado Libre</div>

        <div>
          <label>Desde</label><br/>
          <input id="from" type="date"/>
        </div>
        <div>
          <label>Hasta</label><br/>
          <input id="to" type="date"/>
        </div>

        <button id="load" class="btn">Cargar</button>
        <a id="csv" class="btn secondary" href="#" download>Descargar CSV</a>

        <div id="summary" class="meta">—</div>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const tbl = document.getElementById('tbl');
    const thead = tbl.querySelector('thead');
    const tbody = tbl.querySelector('tbody');
    const fromEl = document.getElementById('from');
    const toEl   = document.getElementById('to');
    const loadBtn= document.getElementById('load');
    const csvA   = document.getElementById('csv');
    const summary= document.getElementById('summary');

    // Defaults
    const today = new Date();
    const pad = n => String(n).padStart(2,'0');
    const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    fromEl.value = fmt(today); toEl.value = fmt(today);

    loadBtn.addEventListener('click', loadData);
    [fromEl, toEl].forEach(el => el.addEventListener('keydown', e => { if (e.key === 'Enter') loadData(); }));

    async function loadData() {
      const from = fromEl.value;
      const to   = toEl.value;

      const qs = new URLSearchParams({
        from, to,
        pageSize: '50',
        maxPages: '200',
        includeShipment: 'true'
      });
      const url = `/orders?${qs.toString()}`;
      const csvUrl = `/orders.csv?${qs.toString()}`;
      csvA.href = csvUrl;

      summary.textContent = 'Cargando…';
      const res = await fetch(url);
      if (!res.ok) { summary.textContent = 'Error cargando datos'; return; }
      const data = await res.json();
      renderTable(data.headers, data.rows);
      summary.textContent = `Rango: ${data.from} → ${data.to} · Ventas: ${data.count}`;
    }

    function renderTable(headers, rows) {
      thead.innerHTML = '';
      tbody.innerHTML = '';

      // HEADERS
      const trh = document.createElement('tr');
      headers.forEach((h, idx) => {
        const th = document.createElement('th');
        const wrap = document.createElement('div');
        wrap.className = 'th-wrap';
        wrap.textContent = h;

        const rz = document.createElement('span');
        rz.className = 'col-resizer';
        wrap.appendChild(rz);
        th.appendChild(wrap);
        trh.appendChild(th);

        makeResizable(th, idx);
      });
      thead.appendChild(trh);

      // BODY
      rows.forEach(r => {
        const tr = document.createElement('tr');
        r.forEach((cell, idx) => {
          const td = document.createElement('td');
          if (idx === 0 && cell != null) {
            td.classList.add('idcell');
            td.textContent = String(cell);
          } else if (typeof cell === 'number') {
            td.classList.add('num');
            td.textContent = formatNumber(cell);
          } else {
            td.textContent = cell == null ? '' : cell;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      // aplicar anchos guardados o defaults
      restoreOrInitWidths(headers.length);
    }

    function formatNumber(n) {
      try { return n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); }
      catch { return String(n); }
    }

    // ----- Resize -----
    function makeResizable(th, colIndex) {
      const resizer = th.querySelector('.col-resizer');
      if (!resizer) return;

      let startX = 0, startW = 0;
      const minW = 60;

      const onMouseDown = (e) => {
        startX = e.pageX;
        startW = th.offsetWidth;
        document.body.classList.add('resizing');
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      };
      const onMouseMove = (e) => {
        const dx = e.pageX - startX;
        const newW = Math.max(minW, startW + dx);
        setColumnWidth(colIndex, newW);
      };
      const onMouseUp = () => {
        document.body.classList.remove('resizing');
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        saveColumnWidths();
      };
      resizer.addEventListener('mousedown', onMouseDown);
    }

    function setColumnWidth(colIndex, px) {
      const th = thead.querySelector(`th:nth-child(${colIndex+1})`);
      if (th) th.style.width = px + 'px';
      tbody.querySelectorAll('tr').forEach(tr => {
        const td = tr.children[colIndex];
        if (td) td.style.width = px + 'px';
      });
    }

    function getColumnWidths() {
      const ths = [...thead.querySelectorAll('th')];
      return ths.map(th => th.offsetWidth || parseInt(th.style.width || 0, 10) || 0);
    }
    function saveColumnWidths() {
      const widths = getColumnWidths();
      localStorage.setItem('ordersTableWidths', JSON.stringify(widths));
    }
    function restoreOrInitWidths(colCount) {
      const raw = localStorage.getItem('ordersTableWidths');
      let widths = [];
      if (raw) { try { widths = JSON.parse(raw) || []; } catch {} }
      if (!widths || widths.length !== colCount) {
        // defaults amables por columna
        widths = [
          160, 160, 420, 140, 120, 120, 140, 120, 120, 140, 110, 110, 140, 80
        ].slice(0, colCount);
      }
      widths.forEach((w, i) => { if (w && Number.isFinite(w)) setColumnWidth(i, w); });
    }

    // init
    loadData();
  </script>
</body>
</html>

